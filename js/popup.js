class Popup{constructor(){this.storage=STORAGE,this.config={},this.readEnv(),this.initHandlers(),this.initStorage(),this.initListeners()}initListeners(){chrome.runtime.onMessage.addListener(a=>{if("gotIP"===a.action)this.setIp(a.data,a.currentProxy),this.setState("connected");else if("gotIPError"===a.action)this.setIpResolving();else if("disconnected"===a.action)this.setState();else if("start-loader"===a.action)$("#loader").show(),$("#wrapper").addClass("loading");else if("end-loader"===a.action)$("#loader").hide(),$("#wrapper").removeClass("loading");else if("notifications"===a.action&&a.has_message){let b=null;a.link&&(b=`<button class="primary_btn" id="purchase" link="${a.link}">Purchase</button>`),this.showAlert(a.message,b)}})}readEnv(){try{const a=chrome.extension.getURL("/config.json"),b=new XMLHttpRequest;b.open("GET",a,!0),b.onload=()=>(200===b.status&&b.responseText&&(this.config=JSON.parse(b.responseText)),this.config),b.addEventListener("error",()=>{throw"Config is not loaded"}),b.send()}catch(a){Sentry.captureException(a)}}showLogin(){$(".screen").hide(),$(".auth_screen").show()}hideLogin(){$(".main_screen").show(),$(".auth_screen").hide()}initHandlers(){const a=$(document.body);a.on("click",".connection_btn",()=>{this.storage.vpnOn=!this.storage.vpnOn,this.setState("connecting");let a=this;this.storage.vpnOn?setTimeout(function(){a.saveStorage(),a.setIpResolving()},1e3):(this.saveStorage(),this.setIpResolving())}),a.on("submit","form#signin-submit",a=>{a.preventDefault();let b=$("#signin-email").val(),c=$("#signin-password").val();chrome.runtime.sendMessage({action:"signin",email:b,password:c},a=>{if(a)if(a.success)this.initStorage();else if(a&&a.link.has){let b=a.link,c=a.msg;this.showAlert(c,`<button id="error-button" class="primary_btn" link="${b.uri}">${b.title}</button>`)}else{let b=a.msg;this.showAlert(b)}})}),a.on("submit","form#signup-submit",a=>{a.preventDefault();let b=$("#signup-name").val(),c=$("#signup-email").val(),d=$("#signup-password").val();chrome.runtime.sendMessage({action:"signup",email:c,password:d,name:b},a=>{a&&a.success?chrome.runtime.sendMessage({action:"signin",email:c,password:d},a=>{if(a)if(a.success)chrome.tabs.create({url:chrome.extension.getURL("/thankyou.html")}),this.initStorage();else if(a.link.has){let b=a.link,c=a.msg;this.showAlert(c,`<button id="error-button" class="primary_btn" link="${b.uri}">${b.title}</button>`)}else{let b=a.msg;this.showAlert(b)}}):this.showAlert(a.msg)})}),a.on("click","button#resend-confirm",()=>{let a=$("#signin-email").val();chrome.runtime.sendMessage({action:"resend-confirm",email:a},a=>{a&&a.success?(this.showLogin(),this.showAlert("Confirmation link has been successfully send")):this.showAlert(a.msg)})}),a.on("submit","form#forgot-submit",a=>{a.preventDefault();let b=$("#forgot-email").val();chrome.runtime.sendMessage({action:"forgot",email:b},a=>{a&&a.success?(this.showLogin(),this.showAlert("We sent a link to reset your password, check your email!")):this.showAlert(a.msg)})}),a.on("click",".forgot_screen #close_btn",()=>{$(".screen").hide(),$(".auth_screen").show().addClass("js-opened")}),a.on("click","a#forgot-link",()=>{$(".screen").hide(),$(".forgot_screen").show().addClass("js-opened")}),a.on("click","button#logout-btn",()=>{chrome.runtime.sendMessage({action:"logout"},()=>{$(".screen").hide(),this.showLogin()})}),a.on("click",".back-login",()=>{this.showLogin()}),a.on("click",".geo_chooser_btn",()=>{$(".geo_screen").show().addClass("js-opened")}),a.on("click","#error-button",()=>{chrome.tabs.create({url:$("#error-button").attr("link")})}),a.on("click","#purchase",()=>{chrome.tabs.create({url:$("#purchase").attr("link")})}),a.on("click","#signin-tab",()=>{$("#signin-tab").addClass("active"),$("#signup-tab").removeClass("active"),$("#signin-tab-content").show(),$("#signup-tab-content").hide()}),a.on("click","#signup-tab",()=>{$("#signup-tab").addClass("active"),$("#signin-tab").removeClass("active"),$("#signin-tab-content").hide(),$("#signup-tab-content").show()}),a.on("click",".geo_screen .back_btn",()=>{$(".main_screen").show(),$(".geo_screen").removeClass("js-opened")}),a.on("click",".settings_screen .close_btn",()=>{$(".main_screen").show(),$(".settings_screen").hide()}),a.on("click",".menu_btn",()=>{$("#settings-general").addClass("js-opened")}),a.on("click","#settings-general-btn",()=>{$(".settings_screen").hide(),$("#settings-general").show()}),a.on("click",".sub_setting_screen .back_btn",()=>{$(".sub_setting_screen").removeClass("js-opened")}),a.on("click",".notification .close_btn, .notification .closebtn",()=>{$(".notification").removeClass("shown"),$(".notification").find("p").html(""),$(".notification").find(".action").html(""),$(".notification").css("position","absolute")}),a.on("click",".js-search",()=>{$(".search_holder").addClass("is-active")}),a.on("click",".js-search-close",()=>{$(".search_holder").removeClass("is-active")}),a.on("click",".add_to_fav_btn",a=>{let c=$(a.target),d=c.closest("li").attr("value"),e=this.storage.favorites,f=e.indexOf(d);-1===f?(c.closest("li").addClass("fav_loc"),e.push(d)):(c.closest("li").removeClass("fav_loc"),0===f?e.shift():e.splice(e.indexOf(d),1)),chrome.runtime.sendMessage({action:"favorite",favorites:e},a=>{a&&a.success&&b.initStorage()})});let b=this;window.onload=function(){chrome.runtime.sendMessage({action:"open-popup"},a=>{a&&a.success&&b.initStorage()})}}showAlert(a,b=null){$(".notification").find("p").text(a),$(".notification").addClass("shown"),$(".notification").css("position","relative"),null===b?$(".notification").find(".action").html(""):$(".notification").find(".action").html(b)}initStorage(){chrome.storage.local.get(this.storage,a=>{this.storage=a,this.run()})}initSentry(){Sentry.init({dsn:"https://8686075a839941d682002ea9114be55a@sentry.uvpn.me/2",environment:"coahpcpgfnnaddeelpphpifmgfobflog"===chrome.runtime.id?chrome.runtime.id:"development"})}saveStorage(){chrome.storage.local.set(this.storage)}run(){this.initSentry();let a="UVPNv2"===this.storage.user_version,b=null===this.storage.user_auth_token||null===this.storage.user_auth_email;a&&b?this.showLogin():(this.hideLogin(),this.initPopup())}initPopup(){chrome.tabs.getCurrent(function(){}),/UVPNv2/.test(this.storage.device_token)&&$("#logout-btn").show().removeClass("disabled-block"),$("#vpn-on").prop("checked",this.storage.vpnOn);let a=this.storage.favorites;const b=this.storage.locations.map(b=>({country_name:b.country_name,value:b.country_code,region:b.region,original_region:b.original_region,mode:b.mode,favorite:a.find(a=>a===b.country_code)?" fav_loc":null}));new XSelect(".main_screen",b,this.storage.country,a=>{$(".geo_screen").hide().removeClass("js-opened"),$(".main_screen").show(),this.storage.country!==a&&(this.storage.country=a,this.storage.vpnOn=!0,this.saveStorage(),this.setState("connecting"),this.setIpResolving())}),this.setState()}setState(a){const b=document.body.classList;this.storage.vpnOn?"connecting"===a?(b.remove("connected"),b.remove("disconnected"),b.add("connecting")):"connected"===a?(b.remove("connecting"),b.remove("disconnected"),b.add("connected")):!a&&(b.remove("connecting"),b.remove("disconnected"),b.add("connected")):(b.remove("connected"),b.remove("connecting"),b.add("disconnected"))}setIp(a,b=!1){b&&b.streaming?($(".destination_location").find(".connection_info").html(a.country_name+", ["+a.ip+"]"),$(".destination_location").find("img").attr("src","/img/flags/"+a.country_code+".png")):($(".destination_location").find(".connection_info").html(a.country_name+", "+a.city+" ["+a.ip+"]"),$(".destination_location").find("img").attr("src","/img/flags/"+a.country_code+".svg")),$(".current_location").find(".connection_info").html(a.original.country_name+", "+a.original.city+" ["+a.original.ip+"]"),$(".current_location").find("img").attr("src","/img/flags/"+a.original.country_code+".svg")}setIpResolving(){$(".connection_info_ip").html("..."),$(".connection_info_name").html("...")}}const p=new Popup;